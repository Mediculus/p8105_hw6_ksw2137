---
title: "P8105 Data Science I - Homework 6"
author: "Kevin S.W.   UNI: ksw2137"
date: "`r format(Sys.time(), '%x')`"
output: github_document
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# global default settings for chunks
knitr::opts_chunk$set(echo = TRUE, 
                      fig.width = 10, 
                      fig.align = "center",
                      results = "asis"
                      )

# loaded packages; placed here to be able to load global settings
Packages <- c("tidyverse", "dplyr", "modelr", "mgcv", "patchwork")
invisible(lapply(Packages, library, character.only = TRUE))


# global settings for color palettes
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# theme global setting for ggplot
theme_set(theme_minimal() + 
            theme(legend.position = "bottom") +
            theme(plot.title = element_text(hjust = 0.5, size = 12),
                  plot.subtitle = element_text(hjust = 0.5, size = 8))
          )

```

# Problem 1
First load our birthweight data.

```{r birthweight}

birthweight_df <- read_csv("./data/Birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate_at(.vars = vars("babysex", "malform", # convert columns in vars() to factors
                         "mrace", "frace"
                         ),   
            .funs = funs(factor)) %>% 
  mutate(
    babysex = fct_recode(babysex, male = "1", female = "2"),
    malform = fct_recode(malform, absent = "0", present = "1")
    )

skimr::skim(birthweight_df)                   # remove "#" to activate skimr check 

```

After loading our birthweight data, we obtain a `r nrow(birthweight_df)` by `r ncol(birthweight_df)` dataset that all started as numeric variables. `babysex`, `malform`, `frace`, `mrace` were converted to categorical variables as they should. 

Variables are:

* Baby-related:
  * `bwt`: baby’s birth weight (g)
  * `blength`: baby’s length at birth (cm)
  * `bhead`: baby’s head circumference at birth (cm)
  * `babysex`: baby’s sex (male = 1, female = 2)
  * `gaweeks`: gestational age in weeks
  * `malform`: presence of malformations that could affect weight (0 = absent, 1 = present)
* Mom-related:
  * `delwt`: mother’s weight at delivery (lbs)
  * `wtgain`: mother’s weight gain during pregnancy (pounds)
  * `ppwt`: mother’s pre-pregnancy weight (pounds)
  * `ppbmi`: mother’s pre-pregnancy BMI
  * `mheigth`: mother’s height (in.)
  * `momage`: mother’s age at delivery (years)
  * `menarche`: mother’s age at menarche (first menstruation; in years)
  * `mrace`: mother’s race (1 = White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other)
  * `parity`: number of live births prior to this pregnancy
  * `pnumlbw`: previous number of low birth weight babies
  * `pnumsga`: number of prior small-for-gestational-age babies
  * `smoken`: average number of cigarettes smoked per day during pregnancy
* Family/father-related:
  * `frace`: father’s race (1 = White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other, 9 = Unknown)
  * `fincome`: family monthly income (in hundreds, rounded)

`skimr::skim()` reveals no missing variables. However, it reveals some variables that likely shouldn't even be considered; `pnumlbw` and `pnumsga`, though measures numbers of babies, only records `0` in this dataset.

### Model Proposal
Will attempt to make a model with `bwt` as our outcome. Looking at `skimr::skim()`'s histogram and combination with some plausible physiological relationships, initial model will contain `blength` (weight should increase with length), `gaweeks` (increased gestation period should result in more physical growth). `bhead` not included because likely correlated to `blength`. `babysex` will likely not be correlated for birthweight. `malform` should influence `bwt` but our skimr indicates that this variable is highly skewed.

`wtgain` variable from mother could potentially be a factor. Correlation likely between mom's `delwt`, `wtgain`, `ppwt`, `ppbmi` so these other variables are not included. `mheight`, `momage`, `menarche`, `mrace`, `frace`, `parity`, `fincome` likely unrelated. `pnumlbw`, `pnumsga`, `smoken` removed because data points are either highly skewed or does not contain useful information.

```{r}

first_fit <- birthweight_df %>% 
  lm(bwt ~ gaweeks + blength + wtgain, data = .)

summary(first_fit)

first_fit %>% 
  broom::glance()

first_fit %>% 
  broom::tidy()

```


Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values – use add_predictions and add_residuals in making this plot.

Compare your model to two others:

* Model 1: length at birth, gestational age as predictors (main effects only)

```{r}

birthweight_df %>% 
  ggplot(aes(x = wtgain, y = bwt, color = menarche)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm")

model1 <- birthweight_df %>% 
  lm(bwt ~ blength + gaweeks, data = .)

summary(model1)

```


* Model 2: head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}

model2 <- birthweight_df %>% 
  lm(bwt ~ bhead * blength * babysex, data = .)


summary(first_fit)
summary(model1)
summary(model2)

```


Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

Note that although we expect your model to be reasonable, model building itself is not a main idea of the course and we don’t necessarily expect your model to be “optimal"

# Problem 2 - Weather Data
In this problem we'll be using weather data for Central Park, NY in 2017. Code adopted from homework website. 

```{r CP_2017_load, cache = TRUE}

# loads weather data; code from homework website.
weather_df <- 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

```

After loading the data, we should clean it up a bit and only select the things we need before running a bootstrap and obtaining the r̂-squared for each resampling as well as log(beta0*beta1). 

### Data cleaning and bootstrapping

```{r df_clean}

# selects relevant columns and renames Central Park to cp_ny for simplicity
clean_weather_df <- weather_df %>% 
  select(name, tmax, tmin) %>% 
  mutate(
    name = str_replace(name, "CentralPark_NY", "cp_ny")
  )

# runs bootstrap x5000
bootstrap_runs <- clean_weather_df %>% 
  bootstrap(n = 5000) %>% 
  mutate(
    model = map(strap, ~lm(tmax ~ tmin, data = .x)),      # obtains model for each strap sample
    result = map(model, broom::tidy),                     # obtains estimate data from each model
    stat = map(model, broom::glance)                      # obtains statistics from each model
  )

# a cleaned and filtered df containing variables of interest
clean_strap <- bootstrap_runs %>% 
  select(-model, -strap) %>%                              # removed the original strap sample and model
  rename("strap_run" = .id) %>%                           # renamed id to "run numbers"
  unnest() %>%                                            # unnest the tibbles that remained
  select(strap_run, term, estimate, adj.r.squared) %>%    # selected relevant measures
  mutate(
    term = case_when(term == "(Intercept)" ~ "beta0",     # renamed intercept to beta0
                     term == "tmin" ~ "beta1",            # renamed slope to beta1
                     TRUE ~ as.character(term))
  ) %>% 
  pivot_wider(names_from = term,                          # put the betas into different columns
              values_from = estimate) %>% 
  mutate(
    estimate_log = log(beta0 * beta1)                     # add column for the ln(b0 * b1)
  )

```

After cleaning and bootstrapping, we isolated only the variables we're interested in, which is stored in `unnested_clean_strap`, we can check their distribution using a simple density plot below

```{r}

# density plot of 
r_squared_plot <- unnested_clean_strap %>% 
  ggplot(aes(x = adj.r.squared)) +
  geom_density(color = "seagreen2", fill = "seagreen2", alpha = 0.3)

estimate_log_plot <- unnested_clean_strap %>% 
  ggplot(aes(x = estimate_log)) +
  geom_density(color = "steelblue1", fill = "steelblue1", alpha = 0.3)

r_squared_plot + estimate_log_plot

```

Plot suggests that both the r-squared and log(beta0 * beta1) are normally distributed. However, note that there is a very slight left skew on the distribution of r-squared, which shouldn't greatly deviate from our assumptions of normality. 

We can build 

Using the 5000 bootstrap estimates, identify the 2.5% and 97.5% quantiles to provide a 95% confidence interval for r̂ 2 and log(β̂ 0∗β̂ 1). Note: broom::glance() is helpful for extracting r̂ 2 from a fitted regression, and broom::tidy() (with some additional wrangling) should help in computing log(β̂ 0∗β̂ 1).
